# CUPAC Variance Reduction Experiments

Содержит реализацию и сравнение классического метода CUPED и расширенного ML-подхода CUPAC на синтетических и реальных данных.

## Методы
**CUPED** (Controlled Experiments Using Pre-Experiment Data) — линейная корректировка целевой метрики с использованием заранее известной ковариаты (pre-period метрики). 

$$
	ilde Y = Y - \theta (X - \mathbb E[X]), \qquad \theta = \frac{\operatorname{Cov}(Y,X)}{\operatorname{Var}(X)}
$$

После корректировки дисперсия снижается до

$$
\operatorname{Var}(\tilde Y) = (1-\rho_{Y,X}^2)\operatorname{Var}(Y),
$$
где $\rho_{Y,X}$ — коэффициент корреляции. Максимальное относительное снижение дисперсии равно $\rho_{Y,X}^2$.

**CUPAC** (обобщение) — ML-подход, строящий оптимальную линейную комбинацию множества ковариат (лаги, агрегаты, производные признаки) через регрессию/модель предсказания. Пусть $X \in \mathbb R^p$ — вектор pre-treatment признаков. Тогда линейный оптимум:

$$
	ilde Y = Y - \beta^\top (X - \mathbb E[X]), \qquad \beta^{*} = \Sigma_{XX}^{-1} \Sigma_{XY}
$$

и
$$
\operatorname{Var}(\tilde Y) = \operatorname{Var}(Y) - \Sigma_{YX}\Sigma_{XX}^{-1}\Sigma_{XY} = (1-R^2)\operatorname{Var}(Y),
$$
где $R^2$ — коэффициент детерминации регрессии $Y$ на $X$. Следовательно Var.Red.% $= 100\cdot R^2$ (при корректной оценке и отсутствии переобучения). В ML-варианте вместо явной формулы для $\beta$ берётся прогноз $\hat Y = f(X)$ из выбранной модели, и используется остаток $R = Y - \hat Y$.

CUPAC:
- Поддержка множества признаков (а не одной ковариаты)
- Перебор/валидация нескольких моделей (Linear, Ridge, Lasso, CatBoost)
- Автовыбор модели по максимальному снижению дисперсии
- Отчет по важности признаков и достигнутому проценту сокращения дисперсии

## Содержание репозитория
- `autocupac.py` — автономная реализация AutoCUPAC трансформера
- `data_gen.py` — генерация синтетических данных для тестов методов
- `R&D synthetic data.ipynb` — первичные эксперименты и проверка идеи на синтетике
- `RealData1_CUPAC.ipynb` — применение AutoCUPAC на первом реальном датасете
- `RealData2_CUPAC.ipynb` — повторное подтверждение результатов на другом реальном датасете
- `WaldEstimator/` — вспомогательные исследования (оценка LATE / Wald) вне основной линии CUPAC, сохранено для полноты R&D

## Ноутбуки и результаты
| Ноутбук | Назначение | Ключевой вывод |
|---------|------------|----------------|
| `R&D.ipynb` | Синтетические сценарии, чувствительность | Демонстрация стабильного выигрыша CUPAC над базовой метрикой |
| `RealData1_CUPAC.ipynb` | Реальные данные (набор 1) | снижение дисперсии 34% |
| `RealData2_CUPAC.ipynb` | Реальные данные (набор 2) | снижение дисперсии 33% |

Численные значения зависят от конкретного запуска (рандомизация treatment, разбиения фолдов, seed). В ноутбуках фиксируем воспроизводимый процесс, а не жёстко одно число.

## Минимальное использование (концепт)


## Интерпретация отчета CUPAC
- Var.Red. (%) — относительное снижение дисперсии целевой метрики
- R² — качество предсказания вспомогательной модели (не цель само по себе, но индикатор объяснённой вариации)
- Важность признаков — нормированное влияние
